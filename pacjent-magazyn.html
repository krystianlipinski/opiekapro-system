<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magazyn Pacjenta - OpiekaPRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
	<script src="supabase.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-content {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">
    <div class="flex h-screen bg-gray-100">
        <!-- Sidebar -->
        <aside class="w-64 flex-shrink-0 bg-slate-900 text-white flex flex-col">
            <div class="h-16 flex items-center justify-center text-2xl font-bold border-b border-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400 mr-2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                <span>OpiekaPRO</span>
            </div>
            <nav id="sidebarNav" class="flex-1 px-4 py-6 space-y-2">
                <a href="pacjenci.html" class="nav-link flex items-center px-4 py-2.5 bg-blue-600 text-white rounded-lg font-semibold shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    Pacjenci
                </a>
                <a href="zadania.html" class="nav-link flex items-center px-4 py-2.5 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M21.2 15c.7-1.2 1-2.5.7-3.9-.6-2.4-3.4-4-6.2-3.3-1.3.3-2.4 1-3.2 2.1-.8-1.1-1.9-1.8-3.2-2.1-2.8-.7-5.6.9-6.2 3.3-.3 1.4 0 2.7.7 3.9l10 10Z"/></svg>
                    Zadania
                </a>
                <a href="uprawnienia.html" class="nav-link flex items-center px-4 py-2.5 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                    Uprawnienia
                </a>
                <a href="magazyn.html" class="nav-link flex items-center px-4 py-2.5 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors"> <!-- Ogólny magazyn -->
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
                    Magazyn
                </a>
				<a href="raporty.html" class="nav-link flex items-center px-4 py-2.5 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>
                    Raporty
                </a>
                <a href="uzytkownicy.html" class="nav-link flex items-center px-4 py-2.5 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M18 9a4 4 0 0 0-7.44 2.13"/><path d="M18 9a4 4 0 0 0-7.44 2.13"/><path d="M14 12a4 4 0 1 0-8 0c0 1.4.67 2.67 1.68 3.51L10 17.5V22h4v-4.5l2.32-1.99A3.95 3.95 0 0 0 14 12Z"/><path d="M6 9a4 4 0 0 1 7.4-2.32"/><path d="M6 9a4 4 0 0 1 7.4-2.32"/></svg>
                    Użytkownicy
                </a>
            </nav>
        </aside>

        <!-- Main content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-white shadow-sm h-16 flex items-center justify-between px-6">
                <div>
                    <h1 class="text-lg font-semibold text-slate-600">Dom Opieki "Słoneczna Przystań"</h1>
                </div>
                <div class="flex items-center">
                    <span class="mr-4 text-slate-700">Witaj, <span class="font-bold">Piotr Ćwikliński</span></span>
                    <a href="login.html" class="nav-link flex items-center text-red-500 hover:text-red-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        Wyloguj się
                    </a>
                </div>
            </header>

            <!-- Content Area -->
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-100 p-6">
                <div class="container mx-auto">
                    <div class="mb-6 text-sm text-slate-500">
                        <a href="pacjenci.html" class="nav-link hover:underline">Pacjenci</a> / <a href="index.html" class="nav-link hover:underline">Jan Kowalski</a> / <span class="font-semibold text-slate-700">Magazyn</span>
                    </div>

                     <div class="flex items-center gap-4 mb-4">
                        <h2 class="text-3xl font-bold text-slate-800">Pacjent: Jan Kowalski</h2>
                        <a href="index.html" class="nav-link text-sm text-blue-600 hover:underline flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="m15 18-6-6 6-6"/></svg>
                            Powrót do szczegółów
                        </a>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <a href="pacjent-zadania.html" class="nav-link flex items-center justify-center p-4 bg-white text-slate-700 rounded-xl shadow-lg hover:bg-slate-50 transition-transform transform hover:-translate-y-1 border border-slate-200">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-slate-500"><path d="M21.2 15c.7-1.2 1-2.5.7-3.9-.6-2.4-3.4-4-6.2-3.3-1.3.3-2.4 1-3.2 2.1-.8-1.1-1.9-1.8-3.2-2.1-2.8-.7-5.6.9-6.2 3.3-.3 1.4 0 2.7.7 3.9l10 10Z"></path></svg>
                            <span class="font-semibold text-lg">Zadania</span>
                            <span class="ml-2 bg-blue-100 text-blue-800 text-sm font-bold px-2.5 py-0.5 rounded-full">12</span>
                        </a>
                         <a href="pacjent-magazyn.html" class="nav-link flex items-center justify-center p-4 bg-blue-500 text-white rounded-xl shadow-lg hover:bg-blue-600 transition-transform transform hover:-translate-y-1">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3"><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
                            <span class="font-semibold text-lg">Magazyn</span>
                        </a>
                        <a href="pacjent-notatki.html" class="nav-link flex items-center justify-center p-4 bg-white text-slate-700 rounded-xl shadow-lg hover:bg-slate-50 transition-transform transform hover:-translate-y-1 border border-slate-200">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-slate-500"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
                            <span class="font-semibold text-lg">Notatki</span>
                        </a>
                         <a href="pacjent-choroby.html" class="nav-link flex items-center justify-center p-4 bg-white text-slate-700 rounded-xl shadow-lg hover:bg-slate-50 transition-transform transform hover:-translate-y-1 border border-slate-200">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-slate-500"><path d="M12 2a4.5 4.5 0 0 0-4.5 4.5v9a4.5 4.5 0 0 0 4.5 4.5 4.5 4.5 0 0 0 4.5-4.5v-9A4.5 4.5 0 0 0 12 2Z"/><path d="M10.5 6.5a1.5 1.5 0 0 1 3 0"/><path d="M10.5 10.5a1.5 1.5 0 0 1 3 0"/><path d="m7.5 14.5 4.5-4.5 4.5 4.5"/></svg>
                            <span class="font-semibold text-lg">Choroby</span>
                        </a>
                    </div>
                    
                    <!-- Patient Inventory Card -->
                    <div class="bg-white rounded-xl shadow-lg border border-slate-200">
                        <div class="p-6 border-b">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                                <div>
                                    <h3 class="text-xl font-bold text-slate-800">Magazyn Pacjenta</h3>
                                    <p class="text-slate-500 mt-1 text-sm">Lista przedmiotów osobistych i leków przypisanych do Jana Kowalskiego.</p>
                                </div>
                                <div class="flex gap-2 w-full sm:w-auto">
                                    <button id="addItemBtn" class="w-full sm:w-auto justify-center flex items-center bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors shadow-sm">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                        Dodaj przedmiot
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="p-4 font-semibold text-slate-600">Przedmiot</th>
                                        <th class="p-4 font-semibold text-slate-600">Kategoria</th>
                                        <th class="p-4 font-semibold text-slate-600">Ilość</th>
                                        <th class="p-4 font-semibold text-slate-600">Data dodania</th>
                                        <th class="p-4 font-semibold text-slate-600 text-right">Akcje</th>
                                    </tr>
                                </thead>
                                <tbody id="inventory-table-body" class="divide-y divide-slate-200">
                                    <!-- Patient's inventory will be inserted here by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Add/Edit Item Modal -->
    <div id="itemModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center p-4">
        <div id="itemModalContent" class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-lg transform transition-all opacity-0 scale-95">
            <form id="itemForm" class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="modalTitle" class="text-xl font-bold text-slate-800">Dodaj nowy przedmiot</h3>
                    <button type="button" id="closeItemModal" class="text-slate-400 hover:text-slate-800 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                </div>
                <div class="space-y-4">
                     <input type="hidden" id="editItemId"> <!-- Hidden field for tracking edits -->
                    <div>
                        <label for="itemName" class="block text-sm font-medium text-slate-700">Nazwa przedmiotu</label>
                        <input type="text" id="itemName" name="itemName" required class="form-input mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="itemCategory" class="block text-sm font-medium text-slate-700">Kategoria</label>
                        <select id="itemCategory" name="itemCategory" class="form-input mt-1 block w-full px-3 py-2 border border-slate-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option>Leki</option>
                            <option>Środki higieny</option>
                            <option>Opatrunki</option>
                            <option>Inne</option>
                        </select>
                    </div>
                     <div>
                        <label for="itemQuantity" class="block text-sm font-medium text-slate-700">Ilość</label>
                        <input type="number" id="itemQuantity" name="itemQuantity" required min="1" class="form-input mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                 <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancelItemModal" class="nav-link bg-white py-2 px-4 border border-slate-300 rounded-md shadow-sm text-sm font-medium text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Anuluj</button>
                    <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Zapisz</button>
                </div>
            </form>
        </div>
    </div>
    
     <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmationModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md transform transition-all opacity-0 scale-95">
             <div class="p-6 text-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-16 h-16 text-red-500 mx-auto mb-4"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                <h3 class="text-xl font-bold text-slate-800">Potwierdź usunięcie</h3>
                <p class="text-slate-500 mt-2">Czy na pewno chcesz usunąć przedmiot: <strong id="itemNameToDelete" class="font-medium"></strong>?</p>
            </div>
            <div class="bg-slate-50 px-6 py-4 flex justify-end gap-3 rounded-b-xl">
                <button type="button" id="cancelDeleteBtn" class="bg-white py-2 px-4 border border-slate-300 rounded-md shadow-sm text-sm font-medium text-slate-700 hover:bg-slate-50">Anuluj</button>
                <button type="button" id="confirmDeleteBtn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700">Usuń</button>
            </div>
        </div>
    </div>
    
    <!-- Unsaved Changes Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md transform transition-all opacity-0 scale-95">
             <div class="p-6 text-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-16 h-16 text-yellow-500 mx-auto mb-4"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                <h3 class="text-xl font-bold text-slate-800">Niezapisane zmiany</h3>
                <p class="text-slate-500 mt-2">Masz niezapisane zmiany w formularzu. Czy na pewno chcesz go opuścić?</p>
            </div>
            <div class="bg-slate-50 px-6 py-4 flex justify-end gap-3 rounded-b-xl">
                <button type="button" id="stayBtn" class="bg-white py-2 px-4 border border-slate-300 rounded-md shadow-sm text-sm font-medium text-slate-700 hover:bg-slate-50">Zostań</button>
                <button type="button" id="leaveBtn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700">Opuść</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let patientInventory = [
                { id: 1, name: 'Pieluchy L', category: 'Środki higieny', quantity: 100, added: '2025-09-15' },
                { id: 2, name: 'Okulary do czytania', category: 'Inne', quantity: 1, added: '2025-08-01' },
                { id: 3, name: 'Laska ortopedyczna', category: 'Inne', quantity: 1, added: '2025-09-10' },
                { id: 4, name: 'Ciśnieniomierz', category: 'Inne', quantity: 1, added: '2025-09-22' },
                { id: 5, name: 'Polcard 50mg', category: 'Leki', quantity: 30 , added: '2025-09-22' },
            ];

            const tableBody = document.getElementById('inventory-table-body');
            const itemModal = document.getElementById('itemModal');
            const itemModalContent = document.getElementById('itemModalContent');
            const addItemBtn = document.getElementById('addItemBtn');
            const closeItemModalBtn = document.getElementById('closeItemModal');
            const cancelItemModalBtn = document.getElementById('cancelItemModal');
            const itemForm = document.getElementById('itemForm');
            const modalTitle = document.getElementById('modalTitle');
            const editItemIdInput = document.getElementById('editItemId');
            
            const deleteModal = document.getElementById('deleteConfirmationModal');
            const deleteModalContent = deleteModal.querySelector('.modal-content');
            const itemNameToDeleteSpan = document.getElementById('itemNameToDelete');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            let itemToDeleteId = null;
            
            // Unsaved Changes Modal
            const confirmationModal = document.getElementById('confirmationModal');
            const confirmationModalContent = confirmationModal.querySelector('.modal-content');
            const stayBtn = document.getElementById('stayBtn');
            const leaveBtn = document.getElementById('leaveBtn');
            const navLinks = document.querySelectorAll('.nav-link');
            let isFormDirty = false;
            let targetUrl = null;

            function openModal(modal, content) {
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                setTimeout(() => { if (content) { content.classList.add('scale-100', 'opacity-100'); content.classList.remove('scale-95', 'opacity-0');} }, 10);
            }

            function closeModal(modal, content) {
                 if (content) { content.classList.add('scale-95', 'opacity-0'); content.classList.remove('scale-100', 'opacity-100');}
                setTimeout(() => {
                    modal.classList.add('hidden');
                    document.body.style.overflow = 'auto';
                }, 200);
            }
            
            function renderTable() {
                tableBody.innerHTML = '';
                if(patientInventory.length === 0) {
                     tableBody.innerHTML = '<tr><td colspan="5" class="text-center p-6 text-slate-500">Brak przedmiotów przypisanych do pacjenta.</td></tr>';
                     return;
                }
                
                patientInventory.forEach(item => {
                    tableBody.innerHTML += `
                        <tr class="hover:bg-slate-50">
                            <td class="p-4 font-semibold text-slate-800">${item.name}</td>
                            <td class="p-4 text-slate-600">${item.category}</td>
                            <td class="p-4 text-slate-600">${item.quantity} szt.</td>
                            <td class="p-4 text-slate-500">${item.added}</td>
                            <td class="p-4 text-right">
                                <button class="edit-item-btn text-slate-400 hover:text-blue-600 p-2 rounded-full hover:bg-slate-100 transition-colors" title="Edytuj" data-id="${item.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 pointer-events-none"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                </button>
                                <button class="delete-item-btn text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-100 transition-colors" title="Wycofaj/Usuń" data-id="${item.id}" data-name="${item.name}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 pointer-events-none"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }

            // Event Delegation for Edit/Delete buttons
            tableBody.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-item-btn');
                const deleteBtn = e.target.closest('.delete-item-btn');

                if (editBtn) {
                    const id = parseInt(editBtn.dataset.id);
                    const item = patientInventory.find(i => i.id === id);
                    if (item) {
                        modalTitle.textContent = 'Edytuj przedmiot';
                        editItemIdInput.value = item.id;
                        document.getElementById('itemName').value = item.name;
                        document.getElementById('itemCategory').value = item.category;
                        document.getElementById('itemQuantity').value = item.quantity;
                        isFormDirty = false; // Reset dirty flag on opening
                        openModal(itemModal, itemModalContent);
                    }
                }

                if (deleteBtn) {
                    itemToDeleteId = parseInt(deleteBtn.dataset.id);
                    itemNameToDeleteSpan.textContent = deleteBtn.dataset.name;
                    openModal(deleteModal, deleteModalContent);
                }
            });

            // Add Item Modal
            addItemBtn.addEventListener('click', () => {
                modalTitle.textContent = 'Dodaj nowy przedmiot';
                itemForm.reset();
                editItemIdInput.value = ''; // Ensure no ID is set
                isFormDirty = false; // Reset dirty flag
                openModal(itemModal, itemModalContent);
            });
            
            closeItemModalBtn.addEventListener('click', () => closeModal(itemModal, itemModalContent));
            // cancelItemModalBtn is handled by nav-link logic
            itemModal.addEventListener('click', e => e.target === itemModal && closeModal(itemModal, itemModalContent));

            // Form Submit (Add/Edit)
            itemForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = parseInt(editItemIdInput.value);
                const name = document.getElementById('itemName').value;
                const category = document.getElementById('itemCategory').value;
                const quantity = parseInt(document.getElementById('itemQuantity').value);

                if (id) {
                    // Edit
                    const index = patientInventory.findIndex(i => i.id === id);
                    if (index !== -1) {
                        patientInventory[index] = { ...patientInventory[index], name, category, quantity };
                    }
                } else {
                    // Add
                    const newItem = {
                        id: Date.now(), // Simple unique ID
                        name,
                        category,
                        quantity,
                        added: new Date().toISOString().split('T')[0] // Format: YYYY-MM-DD
                    };
                    patientInventory.push(newItem);
                }
                renderTable();
                isFormDirty = false; // Reset dirty flag on save
                closeModal(itemModal, itemModalContent);
            });

            // Delete Confirmation Modal Logic
            cancelDeleteBtn.addEventListener('click', () => closeModal(deleteModal, deleteModalContent));
            deleteModal.addEventListener('click', e => e.target === deleteModal && closeModal(deleteModal, deleteModalContent));
            confirmDeleteBtn.addEventListener('click', () => {
                if (itemToDeleteId !== null) {
                    patientInventory = patientInventory.filter(item => item.id !== itemToDeleteId);
                    renderTable();
                }
                closeModal(deleteModal, deleteModalContent);
                itemToDeleteId = null;
            });
            
            // Track form changes
            itemForm.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('input', () => { isFormDirty = true; });
            });
            
            // Unsaved changes logic
            function openWarningModal(url) {
                targetUrl = url;
                openModal(confirmationModal, confirmationModalContent);
            }
            function closeWarningModal() {
                closeModal(confirmationModal, confirmationModalContent);
                targetUrl = null;
            }
            
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    const modal = e.target.closest('#itemModal'); // Check if click is inside the item modal
                    const isCancelInModal = e.target.id === 'cancelItemModal';
                    
                    if (isFormDirty && (isCancelInModal || !modal)) {
                        e.preventDefault();
                        let href = isCancelInModal ? '#' : link.href; // Get href if it's a real link
                        openWarningModal(href);
                    }
                });
            });

            stayBtn.addEventListener('click', closeWarningModal);
            leaveBtn.addEventListener('click', () => {
                isFormDirty = false; // Allow navigation
                if (targetUrl && targetUrl !== '#') {
                    window.location.href = targetUrl;
                } else {
                    closeWarningModal(); // Close this modal
                    closeModal(itemModal, itemModalContent); // Also close the item modal if 'Anuluj' was clicked
                }
            });
            confirmationModal.addEventListener('click', e => { if (e.target === confirmationModal) closeWarningModal(); });


            // Initial Render
            renderTable();
        });
    </script>
</body>
</html>


