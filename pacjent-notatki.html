<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notatki Pacjenta - OpiekaPRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
	<script src="supabase.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-content {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">
    <div class="flex h-screen bg-gray-100">
        <!-- Sidebar -->
        <aside class="w-64 flex-shrink-0 bg-slate-900 text-white flex flex-col">
            <div class="h-16 flex items-center justify-center text-2xl font-bold border-b border-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400 mr-2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                <span>OpiekaPRO</span>
            </div>
            <nav id="sidebarNav" class="flex-1 px-4 py-6 space-y-2">
                <a href="pacjenci.html" class="nav-link flex items-center px-4 py-2.5 bg-blue-600 text-white rounded-lg font-semibold shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    Pacjenci
                </a>
                <a href="zadania.html" class="nav-link flex items-center px-4 py-2.5 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M21.2 15c.7-1.2 1-2.5.7-3.9-.6-2.4-3.4-4-6.2-3.3-1.3.3-2.4 1-3.2 2.1-.8-1.1-1.9-1.8-3.2-2.1-2.8-.7-5.6.9-6.2 3.3-.3 1.4 0 2.7.7 3.9l10 10Z"/></svg>
                    Zadania
                </a>
                <a href="uprawnienia.html" class="nav-link flex items-center px-4 py-2.5 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                    Uprawnienia
                </a>
                <a href="magazyn.html" class="nav-link flex items-center px-4 py-2.5 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
                    Magazyn
                </a>
				<a href="raporty.html" class="nav-link flex items-center px-4 py-2.5 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>
                    Raporty
                </a>
                <a href="uzytkownicy.html" class="nav-link flex items-center px-4 py-2.5 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M18 9a4 4 0 0 0-7.44 2.13"/><path d="M18 9a4 4 0 0 0-7.44 2.13"/><path d="M14 12a4 4 0 1 0-8 0c0 1.4.67 2.67 1.68 3.51L10 17.5V22h4v-4.5l2.32-1.99A3.95 3.95 0 0 0 14 12Z"/><path d="M6 9a4 4 0 0 1 7.4-2.32"/><path d="M6 9a4 4 0 0 1 7.4-2.32"/></svg>
                    Użytkownicy
                </a>
            </nav>
        </aside>

        <!-- Main content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-white shadow-sm h-16 flex items-center justify-between px-6">
                <div>
                    <h1 class="text-lg font-semibold text-slate-600">Dom Opieki "Słoneczna Przystań"</h1>
                </div>
                <div class="flex items-center">
                    <span class="mr-4 text-slate-700">Witaj, <span class="font-bold">Piotr Ćwikliński</span></span>
                    <a href="login.html" class="nav-link flex items-center text-red-500 hover:text-red-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        Wyloguj się
                    </a>
                </div>
            </header>

            <!-- Content Area -->
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-100 p-6">
                <div class="container mx-auto">
                    <div class="mb-6 text-sm text-slate-500">
                        <a href="pacjenci.html" class="nav-link hover:underline">Pacjenci</a> / <a href="index.html" class="nav-link hover:underline">Jan Kowalski</a> / <span class="font-semibold text-slate-700">Notatki</span>
                    </div>

                    <div class="flex items-center gap-4 mb-4">
                        <h2 class="text-3xl font-bold text-slate-800">Pacjent: Jan Kowalski</h2>
                        <a href="index.html" class="nav-link text-sm text-blue-600 hover:underline flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="m15 18-6-6 6-6"/></svg>
                            Powrót do szczegółów
                        </a>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <a href="pacjent-zadania.html" class="nav-link flex items-center justify-center p-4 bg-white text-slate-700 rounded-xl shadow-lg hover:bg-slate-50 transition-transform transform hover:-translate-y-1 border border-slate-200">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-slate-500"><path d="M21.2 15c.7-1.2 1-2.5.7-3.9-.6-2.4-3.4-4-6.2-3.3-1.3.3-2.4 1-3.2 2.1-.8-1.1-1.9-1.8-3.2-2.1-2.8-.7-5.6.9-6.2 3.3-.3 1.4 0 2.7.7 3.9l10 10Z"></path></svg>
                            <span class="font-semibold text-lg">Zadania</span>
                            <span class="ml-2 bg-blue-100 text-blue-800 text-sm font-bold px-2.5 py-0.5 rounded-full">12</span>
                        </a>
                        <a href="pacjent-magazyn.html" class="nav-link flex items-center justify-center p-4 bg-white text-slate-700 rounded-xl shadow-lg hover:bg-slate-50 transition-transform transform hover:-translate-y-1 border border-slate-200">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-slate-500"><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
                            <span class="font-semibold text-lg">Magazyn</span>
                        </a>
                        <a href="pacjent-notatki.html" class="nav-link flex items-center justify-center p-4 bg-blue-500 text-white rounded-xl shadow-lg hover:bg-blue-600 transition-transform transform hover:-translate-y-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
                            <span class="font-semibold text-lg">Notatki</span>
                        </a>
                         <a href="pacjent-choroby.html" class="nav-link flex items-center justify-center p-4 bg-white text-slate-700 rounded-xl shadow-lg hover:bg-slate-50 transition-transform transform hover:-translate-y-1 border border-slate-200">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-slate-500"><path d="M12 2a4.5 4.5 0 0 0-4.5 4.5v9a4.5 4.5 0 0 0 4.5 4.5 4.5 4.5 0 0 0 4.5-4.5v-9A4.5 4.5 0 0 0 12 2Z"/><path d="M10.5 6.5a1.5 1.5 0 0 1 3 0"/><path d="M10.5 10.5a1.5 1.5 0 0 1 3 0"/><path d="m7.5 14.5 4.5-4.5 4.5 4.5"/></svg>
                            <span class="font-semibold text-lg">Choroby</span>
                        </a>
                    </div>
                    
                    <!-- Notes Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div id="notesListContainer" class="lg:col-span-2 space-y-4">
                            <!-- Note 1 -->
                            <div class="note-card bg-white rounded-xl shadow-lg border border-slate-200">
                                <div class="p-4 note-content">
                                    <p class="text-slate-700 leading-relaxed">Pacjent zgłasza ból w lewym kolanie, nasilający się przy chodzeniu. Podano lek przeciwbólowy zgodnie z zaleceniami lekarza. Nastrój pacjenta jest dobry, apetyt również.</p>
                                </div>
                                <div class="p-4 bg-slate-50 border-t flex justify-between items-center text-sm">
                                    <span class="text-slate-500">Dodane przez: <span class="font-semibold">Alicja Nowicka</span>, dnia: 20.10.2025, 09:15</span>
                                    <div class="flex gap-2 note-actions">
                                        <button class="edit-note-btn text-slate-500 hover:text-blue-600 p-1" title="Edytuj">
                                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 pointer-events-none"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                        </button>
                                        <button class="delete-note-btn text-red-500 hover:text-red-700 p-1" title="Usuń">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 pointer-events-none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                             <!-- Note 2 -->
                            <div class="note-card bg-white rounded-xl shadow-lg border border-slate-200">
                                <div class="p-4 note-content">
                                    <p class="text-slate-700 leading-relaxed">Odwiedziny córki, Anny Kowalskiej. Pacjent był bardzo zadowolony. Wspólnie oglądali album ze zdjęciami. Córka poinformowała, że dostarczy nowy sweter w przyszłym tygodniu.</p>
                                </div>
                                <div class="p-4 bg-slate-50 border-t flex justify-between items-center text-sm">
                                    <span class="text-slate-500">Dodane przez: <span class="font-semibold">Piotr Ćwikliński</span>, dnia: 18.10.2025, 14:30</span>
                                    <div class="flex gap-2 note-actions">
                                        <button class="edit-note-btn text-slate-500 hover:text-blue-600 p-1" title="Edytuj">
                                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 pointer-events-none"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                        </button>
                                        <button class="delete-note-btn text-red-500 hover:text-red-700 p-1" title="Usuń">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 pointer-events-none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Add Note Form -->
                        <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6 h-fit">
                            <h3 class="text-xl font-bold text-slate-800 mb-4">Dodaj nową notatkę</h3>
                            <form id="addNoteForm">
                                <div class="relative">
                                    <textarea id="newNoteText" maxlength="500" class="form-input w-full h-40 p-3 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none" placeholder="Wpisz treść notatki..."></textarea>
                                    <div id="charCounter" class="absolute bottom-2 right-2 text-xs text-slate-400">0 / 500</div>
                                </div>
                                <button type="submit" class="mt-4 w-full justify-center flex items-center bg-blue-500 text-white px-4 py-2.5 rounded-lg hover:bg-blue-600 transition-colors shadow-sm font-semibold">
                                    Zapisz notatkę
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Unsaved Changes Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md transform transition-all opacity-0 scale-95">
             <div class="p-6 text-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-16 h-16 text-yellow-500 mx-auto mb-4"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                <h3 class="text-xl font-bold text-slate-800">Niezapisane zmiany</h3>
                <p class="text-slate-500 mt-2">Masz niezapisaną notatkę. Czy na pewno chcesz opuścić tę stronę?</p>
            </div>
            <div class="bg-slate-50 px-6 py-4 flex justify-end gap-3 rounded-b-xl">
                <button type="button" id="stayBtn" class="bg-white py-2 px-4 border border-slate-300 rounded-md shadow-sm text-sm font-medium text-slate-700 hover:bg-slate-50">Zostań</button>
                <button type="button" id="leaveBtn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700">Opuść</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Note Confirmation Modal -->
    <div id="deleteNoteModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md transform transition-all opacity-0 scale-95">
             <div class="p-6 text-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-16 h-16 text-red-500 mx-auto mb-4"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                <h3 class="text-xl font-bold text-slate-800">Potwierdź usunięcie</h3>
                <p class="text-slate-500 mt-2">Czy na pewno chcesz usunąć tę notatkę?</p>
            </div>
            <div class="bg-slate-50 px-6 py-4 flex justify-end gap-3 rounded-b-xl">
                <button type="button" id="cancelDeleteBtn" class="bg-white py-2 px-4 border border-slate-300 rounded-md shadow-sm text-sm font-medium text-slate-700 hover:bg-slate-50">Anuluj</button>
                <button type="button" id="confirmDeleteBtn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700">Usuń</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const addNoteForm = document.getElementById('addNoteForm');
            const newNoteTextarea = document.getElementById('newNoteText');
            const charCounter = document.getElementById('charCounter');
            const notesListContainer = document.getElementById('notesListContainer');
            const maxLength = 500;
            let isFormDirty = false;
            let currentEditingCard = null; // Śledzi aktualnie edytowaną notatkę
            let originalNoteHTML = null; // Przechowuje oryginalny HTML notatki podczas edycji

            // 1. Char Counter
            newNoteTextarea.addEventListener('input', () => {
                const currentLength = newNoteTextarea.value.length;
                charCounter.textContent = `${currentLength} / ${maxLength}`;
                isFormDirty = currentLength > 0; // Form is dirty if there is text
            });

            // 2. Add Note Form Submission
            addNoteForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const text = newNoteTextarea.value.trim();
                if (text === '') return;

                const now = new Date();
                const timestamp = now.toLocaleString('pl-PL', { dateStyle: 'short', timeStyle: 'short' });
                const author = "Piotr Ćwikliński"; // Mock author from header

                const noteHtml = `
                <div class="note-card bg-white rounded-xl shadow-lg border border-slate-200">
                    <div class="p-4 note-content">
                        <p class="text-slate-700 leading-relaxed">${text.replace(/\n/g, '<br>')}</p>
                    </div>
                    <div class="p-4 bg-slate-50 border-t flex justify-between items-center text-sm">
                        <span class="text-slate-500">Dodane przez: <span class="font-semibold">${author}</span>, dnia: ${timestamp}</span>
                        <div class="flex gap-2 note-actions">
                            <button class="edit-note-btn text-slate-500 hover:text-blue-600 p-1" title="Edytuj">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 pointer-events-none"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                            </button>
                            <button class="delete-note-btn text-red-500 hover:text-red-700 p-1" title="Usuń">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 pointer-events-none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>`;

                notesListContainer.insertAdjacentHTML('afterbegin', noteHtml);

                newNoteTextarea.value = '';
                charCounter.textContent = '0 / 500';
                isFormDirty = false;
            });

            // 3. Unsaved Changes Warning (dla formularza dodawania)
            const confirmationModal = document.getElementById('confirmationModal');
            const confirmationModalContent = confirmationModal.querySelector('.modal-content');
            const stayBtn = document.getElementById('stayBtn');
            const leaveBtn = document.getElementById('leaveBtn');
            const navLinks = document.querySelectorAll('.nav-link');
            let targetUrl = null;

            function openModal(modal, content) {
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                setTimeout(() => { if (content) { content.classList.add('scale-100', 'opacity-100'); content.classList.remove('scale-95', 'opacity-0');} }, 10);
            }

            function closeModal(modal, content) {
                if (content) { content.classList.add('scale-95', 'opacity-0'); content.classList.remove('scale-100', 'opacity-100');}
                setTimeout(() => {
                    modal.classList.add('hidden');
                    document.body.style.overflow = 'auto';
                }, 200);
            }

            function openWarningModal(url) {
                targetUrl = url;
                openModal(confirmationModal, confirmationModalContent);
            }
            function closeWarningModal() {
                closeModal(confirmationModal, confirmationModalContent);
                targetUrl = null;
            }

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    if (isFormDirty) {
                        e.preventDefault();
                        openWarningModal(link.href);
                    }
                });
            });

            stayBtn.addEventListener('click', closeWarningModal);
            leaveBtn.addEventListener('click', () => {
                isFormDirty = false;
                if (targetUrl) window.location.href = targetUrl;
                else closeWarningModal();
            });
            confirmationModal.addEventListener('click', e => { if (e.target === confirmationModal) closeWarningModal(); });
            
            // 4. Delete Note Logic
            const deleteModal = document.getElementById('deleteNoteModal');
            const deleteModalContent = deleteModal.querySelector('.modal-content');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            let noteToDelete = null;

            function openDeleteModal(card) {
                noteToDelete = card;
                openModal(deleteModal, deleteModalContent);
            }
            function closeDeleteModal() {
                closeModal(deleteModal, deleteModalContent);
                noteToDelete = null;
            }
            
            cancelDeleteBtn.addEventListener('click', closeDeleteModal);
            deleteModal.addEventListener('click', e => e.target === deleteModal && closeDeleteModal());
            confirmDeleteBtn.addEventListener('click', () => {
                if(noteToDelete) {
                    noteToDelete.remove();
                }
                closeDeleteModal();
            });

            // 5. Edit Note Logic (Event Delegation)
            notesListContainer.addEventListener('click', (e) => {
                const target = e.target;
                const card = target.closest('.note-card');
                if (!card) return;

                // Handle Delete
                if (target.closest('.delete-note-btn')) {
                    openDeleteModal(card);
                    return;
                }

                // Handle Edit
                if (target.closest('.edit-note-btn')) {
                    // Jeśli inna notatka jest edytowana, anuluj tamtą edycję
                    if(currentEditingCard && currentEditingCard !== card) {
                        currentEditingCard.querySelector('.note-content').innerHTML = originalNoteHTML;
                        currentEditingCard.querySelector('.note-actions').innerHTML = `
                            <button class="edit-note-btn text-slate-500 hover:text-blue-600 p-1" title="Edytuj">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 pointer-events-none"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                            </button>
                            <button class="delete-note-btn text-red-500 hover:text-red-700 p-1" title="Usuń">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 pointer-events-none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>`;
                    }
                    
                    currentEditingCard = card;
                    const noteContentDiv = card.querySelector('.note-content');
                    const noteText = noteContentDiv.querySelector('p').innerHTML.replace(/<br\s*\/?>/mg, "\n"); // Konwertuj <br> na nowe linie
                    originalNoteHTML = noteContentDiv.innerHTML; // Zapisz oryginalne <p>

                    // Zamień <p> na <textarea>
                    noteContentDiv.innerHTML = `
                        <textarea class="form-input w-full h-32 p-2 border border-slate-300 rounded-md shadow-sm">${noteText}</textarea>
                    `;
                    // Zamień przyciski
                    const actionsDiv = card.querySelector('.note-actions');
                    actionsDiv.innerHTML = `
                        <button class="cancel-edit-btn text-slate-500 hover:text-red-600 font-medium">Anuluj</button>
                        <button class="save-edit-btn text-blue-600 hover:text-blue-800 font-medium">Zapisz</button>
                    `;
                    return;
                }
                
                // Handle Save Edit
                if (target.closest('.save-edit-btn')) {
                    const newText = card.querySelector('textarea').value;
                    const newTextHtml = newText.trim().replace(/\n/g, '<br>'); // Konwertuj z powrotem na <br>
                    
                    card.querySelector('.note-content').innerHTML = `<p class="text-slate-700 leading-relaxed">${newTextHtml || "Notatka usunięta."}</p>`;
                    card.querySelector('.note-actions').innerHTML = `
                        <button class="edit-note-btn text-slate-500 hover:text-blue-600 p-1" title="Edytuj">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 pointer-events-none"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                        </button>
                        <button class="delete-note-btn text-red-500 hover:text-red-700 p-1" title="Usuń">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 pointer-events-none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>`;
                    
                    currentEditingCard = null;
                    originalNoteHTML = null;
                    return;
                }

                // Handle Cancel Edit
                if (target.closest('.cancel-edit-btn')) {
                    card.querySelector('.note-content').innerHTML = originalNoteHTML;
                    card.querySelector('.note-actions').innerHTML = `
                        <button class="edit-note-btn text-slate-500 hover:text-blue-600 p-1" title="Edytuj">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 pointer-events-none"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                        </button>
                        <button class="delete-note-btn text-red-500 hover:text-red-700 p-1" title="Usuń">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 pointer-events-none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>`;
                    
                    currentEditingCard = null;
                    originalNoteHTML = null;
                    return;
                }
            });

        });
    </script>
</body>
</html>


