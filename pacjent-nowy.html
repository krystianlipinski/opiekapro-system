<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dodaj Nowego Pacjenta - OpiekaPRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
         .modal-content {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
         #photoPreview {
            background-color: #e2e8f0; /* bg-slate-200 */
            background-image: url('https://placehold.co/128x128/E2E8F0/475569?text=?');
            background-size: cover;
            background-position: center;
         }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">
    <div class="flex h-screen bg-gray-100">
        <!-- Sidebar -->
        <aside class="w-64 flex-shrink-0 bg-slate-900 text-white flex flex-col">
            <div class="h-16 flex items-center justify-center text-2xl font-bold border-b border-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400 mr-2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                <span>OpiekaPRO</span>
            </div>
            <nav id="sidebarNav" class="flex-1 px-4 py-6 space-y-2">
                <a href="pacjenci.html" class="flex items-center px-4 py-2.5 bg-blue-600 text-white rounded-lg font-semibold shadow-md nav-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    Pacjenci
                </a>
                <a href="zadania.html" class="flex items-center px-4 py-2.5 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors nav-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M21.2 15c.7-1.2 1-2.5.7-3.9-.6-2.4-3.4-4-6.2-3.3-1.3.3-2.4 1-3.2 2.1-.8-1.1-1.9-1.8-3.2-2.1-2.8-.7-5.6.9-6.2 3.3-.3 1.4 0 2.7.7 3.9l10 10Z"/></svg>
                    Zadania
                </a>
                <a href="uprawnienia.html" class="flex items-center px-4 py-2.5 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors nav-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                    Uprawnienia
                </a>
                <a href="magazyn.html" class="flex items-center px-4 py-2.5 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors nav-link">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
                    Magazyn
                </a>
				<a href="raporty.html" class="nav-link flex items-center px-4 py-2.5 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>
                    Raporty
                </a>
                <a href="uzytkownicy.html" class="flex items-center px-4 py-2.5 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors nav-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M18 9a4 4 0 0 0-7.44 2.13"/><path d="M18 9a4 4 0 0 0-7.44 2.13"/><path d="M14 12a4 4 0 1 0-8 0c0 1.4.67 2.67 1.68 3.51L10 17.5V22h4v-4.5l2.32-1.99A3.95 3.95 0 0 0 14 12Z"/><path d="M6 9a4 4 0 0 1 7.4-2.32"/><path d="M6 9a4 4 0 0 1 7.4-2.32"/></svg>
                    Użytkownicy
                </a>
            </nav>
        </aside>

        <!-- Main content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-white shadow-sm h-16 flex items-center justify-between px-6">
                <div>
                    <h1 class="text-lg font-semibold text-slate-600">Dom Opieki "Słoneczna Przystań"</h1>
                </div>
                <div class="flex items-center">
                    <span class="mr-4 text-slate-700">Witaj, <span class="font-bold">Piotr Ćwikliński</span></span>
                    <a href="login.html" class="flex items-center text-red-500 hover:text-red-700 transition-colors nav-link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        Wyloguj się
                    </a>
                </div>
            </header>

            <!-- Content Area -->
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-100 p-6">
                <div class="container mx-auto max-w-3xl">
                    <div class="mb-6">
                         <h2 class="text-3xl font-bold text-slate-800">Dodaj Nowego Pacjenta</h2>
                         <p class="text-slate-500 mt-1">Wypełnij formularz, aby zarejestrować nowego pacjenta w systemie.</p>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg border border-slate-200">
                        <form id="addPatientForm" action="pacjenci.html" method="GET"> <!-- Action set to redirect to patient list -->
                            <div class="p-6 space-y-6">
                                <!-- Personal Data & Photo -->
                                <section>
                                     <h3 class="text-xl font-semibold text-slate-800 border-b pb-2 mb-4">Dane Osobowe i Zdjęcie</h3>
                                     <div class="flex flex-col md:flex-row items-start gap-8">
                                         <!-- Photo Section -->
                                        <div class="w-full md:w-40 flex flex-col items-center flex-shrink-0">
                                            <div id="photoPreview" class="w-32 h-32 rounded-full mb-4 bg-slate-200 bg-center bg-cover"></div>
                                            <!-- Age Display -->
                                            <div class="mb-2 w-full">
                                                 <label class="block text-sm font-medium text-slate-700 text-center">Wiek</label>
                                                 <p id="ageDisplay" class="mt-1 text-center text-lg font-semibold text-slate-800">-</p>
                                             </div>
                                            <input type="file" id="photoInput" accept="image/*" class="hidden form-input">
                                            <button type="button" id="selectFileBtn" class="text-sm bg-white text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-50 transition-colors shadow-sm border border-slate-300 w-full mb-2">Wybierz plik</button>
                                            <button type="button" id="takePhotoBtn" class="text-sm bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 transition-colors shadow-sm w-full">Zrób zdjęcie</button>
                                        </div>
                                        <!-- Personal Data Fields -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 flex-grow">
                                            <div>
                                                <label for="firstName" class="block text-sm font-medium text-slate-700">Imię</label>
                                                <input type="text" id="firstName" name="firstName" required class="form-input mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            </div>
                                            <div>
                                                <label for="lastName" class="block text-sm font-medium text-slate-700">Nazwisko</label>
                                                <input type="text" id="lastName" name="lastName" required class="form-input mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            </div>
                                            <div>
                                                <label for="pesel" class="block text-sm font-medium text-slate-700">PESEL</label>
                                                <input type="text" id="pesel" name="pesel" pattern="\d{11}" title="PESEL musi składać się z 11 cyfr" required class="form-input mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            </div>
                                            <div>
                                                <label for="birthDate" class="block text-sm font-medium text-slate-700">Data urodzenia</label>
                                                <input type="date" id="birthDate" name="birthDate" required class="form-input mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            </div>
                                            <div class="md:col-span-2">
                                                <label for="address" class="block text-sm font-medium text-slate-700">Adres zamieszkania</label>
                                                <input type="text" id="address" name="address" class="form-input mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            </div>
                                        </div>
                                    </div>
                                </section>

                                <!-- Contact Person -->
                                <section>
                                    <h3 class="text-xl font-semibold text-slate-800 border-b pb-2 mb-4">Osoba Kontaktowa</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="contactName" class="block text-sm font-medium text-slate-700">Imię i nazwisko</label>
                                            <input type="text" id="contactName" name="contactName" class="form-input mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label for="contactRelationship" class="block text-sm font-medium text-slate-700">Stopień pokrewieństwa</label>
                                            <input type="text" id="contactRelationship" name="contactRelationship" class="form-input mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label for="contactPhone" class="block text-sm font-medium text-slate-700">Numer telefonu</label>
                                            <input type="tel" id="contactPhone" name="contactPhone" class="form-input mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    </div>
                                </section>

                                <!-- Stay Details -->
                                <section>
                                    <h3 class="text-xl font-semibold text-slate-800 border-b pb-2 mb-4">Szczegóły Pobytu</h3>
                                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="admissionDate" class="block text-sm font-medium text-slate-700">Data przyjęcia</label>
                                            <input type="date" id="admissionDate" name="admissionDate" required class="form-input mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label for="roomNumber" class="block text-sm font-medium text-slate-700">Numer pokoju</label>
                                            <input type="text" id="roomNumber" name="roomNumber" class="form-input mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label for="carePriority" class="block text-sm font-medium text-slate-700">Priorytet opieki</label>
                                            <select id="carePriority" name="carePriority" class="form-input mt-1 block w-full px-3 py-2 border border-slate-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                                <option>Niski</option>
                                                <option selected>Średni</option>
                                                <option>Wysoki</option>
                                            </select>
                                        </div>
                                    </div>
                                </section>
                            </div>
                            <div class="p-6 bg-slate-50 border-t flex justify-end gap-3 rounded-b-xl">
                                <a href="pacjenci.html" id="cancelButton" class="nav-link bg-white py-2 px-4 border border-slate-300 rounded-md shadow-sm text-sm font-medium text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Anuluj</a>
                                <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Zapisz pacjenta</button>
                            </div>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md transform transition-all opacity-0 scale-95">
             <div class="p-6 text-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-16 h-16 text-yellow-500 mx-auto mb-4"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                <h3 class="text-xl font-bold text-slate-800">Niezapisane zmiany</h3>
                <p class="text-slate-500 mt-2">Masz niezapisane zmiany. Czy na pewno chcesz opuścić tę stronę? Pacjent nie zostanie dodany.</p>
            </div>
            <div class="bg-slate-50 px-6 py-4 flex justify-end gap-3 rounded-b-xl">
                <button type="button" id="stayBtn" class="bg-white py-2 px-4 border border-slate-300 rounded-md shadow-sm text-sm font-medium text-slate-700 hover:bg-slate-50">Zostań</button>
                <button type="button" id="leaveBtn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700">Opuść</button>
            </div>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('addPatientForm');
        const formInputs = form.querySelectorAll('.form-input');
        const navLinks = document.querySelectorAll('.nav-link'); // Select all navigation links including cancel
        const confirmationModal = document.getElementById('confirmationModal');
        const modalContent = confirmationModal.querySelector('.modal-content');
        const stayBtn = document.getElementById('stayBtn');
        const leaveBtn = document.getElementById('leaveBtn');

        // Photo elements
        const photoInput = document.getElementById('photoInput');
        const photoPreview = document.getElementById('photoPreview');
        const selectFileBtn = document.getElementById('selectFileBtn');
        const takePhotoBtn = document.getElementById('takePhotoBtn');
        const birthDateInput = document.getElementById('birthDate');
        const ageDisplay = document.getElementById('ageDisplay');

        let isFormDirty = false;
        let targetUrl = null; // Store the URL to navigate to

        // Function to calculate age
        function calculateAge(birthDateString) {
            if (!birthDateString) return '-';
            try {
                const birthDate = new Date(birthDateString);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age >= 0 ? age : '-'; // Return '-' if date is invalid or in the future
            } catch (e) {
                return '-'; // Return '-' on error
            }
        }

        // Update age display when birth date changes
        birthDateInput.addEventListener('change', () => {
             const age = calculateAge(birthDateInput.value);
             ageDisplay.textContent = age !== '-' ? `${age} lat` : '-';
             isFormDirty = true; // Changing date marks form as dirty
             console.log("Form is dirty (birthDate)");
        });
        birthDateInput.addEventListener('input', () => { // Also trigger on input for immediate feedback
             const age = calculateAge(birthDateInput.value);
             ageDisplay.textContent = age !== '-' ? `${age} lat` : '-';
             isFormDirty = true;
             console.log("Form is dirty (birthDate input)");
        });


        // Mark form as dirty on other input change
        formInputs.forEach(input => {
            // Skip birthDateInput as it's handled separately
            if (input.id !== 'birthDate') {
                input.addEventListener('input', () => {
                    isFormDirty = true;
                    console.log("Form is dirty (other input)"); // Debug log
                });
            }
        });

         // --- Photo Logic ---
        selectFileBtn.addEventListener('click', () => {
            photoInput.click(); // Trigger hidden file input
        });

        takePhotoBtn.addEventListener('click', () => {
             console.log("Attempting to open camera...");
             photoPreview.style.backgroundImage = `url('https://placehold.co/128x128/A7F3D0/14532D?text=CAM')`; // Green placeholder for camera
             isFormDirty = true; // Taking a photo counts as a change
        });

        photoInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    photoPreview.style.backgroundImage = `url('${e.target.result}')`;
                }
                reader.readAsDataURL(file);
                isFormDirty = true; // Selecting a photo counts as a change
                console.log("Form is dirty (photo)"); // Debug log
            }
        });

        // Function to open confirmation modal
        function openConfirmationModal(url) {
            targetUrl = url;
            console.log("Opening modal for URL:", url); // Debug log
            confirmationModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            setTimeout(() => {
                 if (modalContent) {
                    modalContent.classList.add('scale-100', 'opacity-100');
                    modalContent.classList.remove('scale-95', 'opacity-0');
                 }
            }, 10);
        }

        // Function to close confirmation modal
        function closeConfirmationModal() {
            console.log("Closing modal"); // Debug log
             if (modalContent) {
                modalContent.classList.add('scale-95', 'opacity-0');
                modalContent.classList.remove('scale-100', 'opacity-100');
             }
            setTimeout(() => {
                confirmationModal.classList.add('hidden');
                document.body.style.overflow = 'auto';
                targetUrl = null;
            }, 200);
        }

        // Add event listeners to all navigation links
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                console.log("Link clicked:", link.href, "Is form dirty?", isFormDirty); // Debug log
                if (isFormDirty) {
                    // Check if the link is external or mailto, allow those
                    if (link.host !== window.location.host || link.protocol === 'mailto:') {
                        return;
                    }
                    e.preventDefault(); // Prevent default navigation
                    openConfirmationModal(link.href);
                }
                 // If form is not dirty, navigation proceeds normally
            });
        });

        // Handle modal buttons
        stayBtn.addEventListener('click', closeConfirmationModal);
        leaveBtn.addEventListener('click', () => {
            if (targetUrl) {
                console.log("Leaving page to:", targetUrl); // Debug log
                isFormDirty = false; // Allow navigation
                window.location.href = targetUrl;
            } else {
                 closeConfirmationModal(); // Close if somehow targetUrl is null
            }
        });

         // Close modal if clicking outside
        confirmationModal.addEventListener('click', e => {
             if (e.target === confirmationModal) {
                 closeConfirmationModal();
             }
         });

        // Reset dirty flag on form submission (successful save)
        form.addEventListener('submit', () => {
             console.log("Form submitted, setting dirty to false"); // Debug log
            isFormDirty = false;
        });

        // Optional: Warn before closing tab/window if form is dirty
        window.addEventListener('beforeunload', (e) => {
          if (isFormDirty) {
             console.log("Beforeunload triggered, form is dirty"); // Debug log
            e.preventDefault(); // Standard practice
            e.returnValue = ''; // Required for Chrome
          }
        });
    });
</script>
</body>
</html>

