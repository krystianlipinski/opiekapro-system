<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dodaj Zadanie - OpiekaPRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-content {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">
    <div class="flex h-screen bg-gray-100">
        <!-- Sidebar -->
        <aside class="w-64 flex-shrink-0 bg-slate-900 text-white flex flex-col">
            <div class="h-16 flex items-center justify-center text-2xl font-bold border-b border-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400 mr-2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                <span>OpiekaPRO</span>
            </div>
            <nav id="sidebarNav" class="flex-1 px-4 py-6 space-y-2">
                <a href="pacjenci.html" class="flex items-center px-4 py-2.5 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors nav-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    Pacjenci
                </a>
                <a href="zadania.html" class="flex items-center px-4 py-2.5 bg-blue-600 text-white rounded-lg font-semibold shadow-md nav-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M21.2 15c.7-1.2 1-2.5.7-3.9-.6-2.4-3.4-4-6.2-3.3-1.3.3-2.4 1-3.2 2.1-.8-1.1-1.9-1.8-3.2-2.1-2.8-.7-5.6.9-6.2 3.3-.3 1.4 0 2.7.7 3.9l10 10Z"/></svg>
                    Zadania
                </a>
                <a href="uprawnienia.html" class="flex items-center px-4 py-2.5 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors nav-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                    Uprawnienia
                </a>
                <a href="magazyn.html" class="flex items-center px-4 py-2.5 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors nav-link">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
                    Magazyn
                </a>
				<a href="raporty.html" class="nav-link flex items-center px-4 py-2.5 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>
                    Raporty
                </a>
                <a href="uzytkownicy.html" class="flex items-center px-4 py-2.5 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors nav-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M18 9a4 4 0 0 0-7.44 2.13"/><path d="M18 9a4 4 0 0 0-7.44 2.13"/><path d="M14 12a4 4 0 1 0-8 0c0 1.4.67 2.67 1.68 3.51L10 17.5V22h4v-4.5l2.32-1.99A3.95 3.95 0 0 0 14 12Z"/><path d="M6 9a4 4 0 0 1 7.4-2.32"/><path d="M6 9a4 4 0 0 1 7.4-2.32"/></svg>
                    Użytkownicy
                </a>
            </nav>
        </aside>

        <!-- Main content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-white shadow-sm h-16 flex items-center justify-between px-6">
                <div>
                    <h1 class="text-lg font-semibold text-slate-600">Dom Opieki "Słoneczna Przystań"</h1>
                </div>
                <div class="flex items-center">
                    <span class="mr-4 text-slate-700">Witaj, <span class="font-bold">Piotr Ćwikliński</span></span>
                    <a href="login.html" class="flex items-center text-red-500 hover:text-red-700 transition-colors nav-link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        Wyloguj się
                    </a>
                </div>
            </header>

            <!-- Content Area -->
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-100 p-6">
                <div class="container mx-auto max-w-2xl">
                    <div class="mb-6">
                        <a href="zadania.html" class="text-sm text-blue-600 hover:underline flex items-center gap-1 mb-2 nav-link">
                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="m15 18-6-6 6-6"/></svg>
                            Anuluj i wróć do listy zadań
                        </a>
                         <h2 class="text-3xl font-bold text-slate-800">Dodaj Nowe Zadanie</h2>
                         <p class="text-slate-500 mt-1">Uzupełnij poniższe pola, aby utworzyć nowe zadanie.</p>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg border border-slate-200">
                        <form id="addTaskForm" class="p-6 space-y-4" action="zadania.html" method="GET">
                            <div>
                                <label for="patientSearch" class="block text-sm font-medium text-slate-700">Pacjent</label>
                                <div class="relative">
                                    <input type="text" id="patientSearch" name="patientSearch" required autocomplete="off" class="form-input mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Wpisz min. 3 litery nazwiska lub imienia...">
                                    <div id="patientSuggestions" class="absolute z-10 w-full bg-white border border-slate-300 rounded-md mt-1 shadow-lg hidden max-h-48 overflow-y-auto">
                                        <!-- Patient suggestions will be populated here -->
                                    </div>
                                    <input type="hidden" id="selectedPatient" name="selectedPatient"> <!-- Hidden input to store selected patient name -->
                                </div>
                            </div>
                            <div>
                                <label for="taskDescription" class="block text-sm font-medium text-slate-700">Opis zadania</label>
                                <textarea id="taskDescription" name="taskDescription" rows="3" class="form-input mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="np. Podanie leku, zmiana opatrunku..."></textarea>
                            </div>
                             <div>
                                <label for="warehouseItem" class="block text-sm font-medium text-slate-700">Przedmiot z magazynu (opcjonalnie)</label>
                                <div class="relative">
                                    <input type="text" id="warehouseItem" name="warehouseItem" autocomplete="off" class="form-input mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Wpisz min. 3 litery nazwy...">
                                    <div id="warehouseSuggestions" class="absolute z-10 w-full bg-white border border-slate-300 rounded-md mt-1 shadow-lg hidden max-h-48 overflow-y-auto">
                                        <!-- Warehouse suggestions will be populated here -->
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="taskDate" class="block text-sm font-medium text-slate-700">Data wykonania</label>
                                    <input type="date" id="taskDate" name="taskDate" class="form-input mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="taskTime" class="block text-sm font-medium text-slate-700">Godzina wykonania</label>
                                    <input type="time" id="taskTime" name="taskTime" class="form-input mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            <div>
                                <label for="taskPriority" class="block text-sm font-medium text-slate-700">Priorytet</label>
                                <select id="taskPriority" name="taskPriority" class="form-input mt-1 block w-full px-3 py-2 border border-slate-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option>Niski</option>
                                    <option selected>Średni</option>
                                    <option>Wysoki</option>
                                </select>
                            </div>
                            <div class="pt-4 flex justify-end gap-3">
                                <a href="zadania.html" id="cancelButton" class="nav-link bg-white py-2 px-4 border border-slate-300 rounded-md shadow-sm text-sm font-medium text-slate-700 hover:bg-slate-50">Anuluj</a>
                                <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">Zapisz zadanie</button>
                            </div>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>

     <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md transform transition-all opacity-0 scale-95">
             <div class="p-6 text-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-16 h-16 text-yellow-500 mx-auto mb-4"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                <h3 class="text-xl font-bold text-slate-800">Niezapisane zmiany</h3>
                <p class="text-slate-500 mt-2">Masz niezapisane zmiany. Czy na pewno chcesz opuścić tę stronę? Zadanie nie zostanie dodane.</p>
            </div>
            <div class="bg-slate-50 px-6 py-4 flex justify-end gap-3 rounded-b-xl">
                <button type="button" id="stayBtn" class="bg-white py-2 px-4 border border-slate-300 rounded-md shadow-sm text-sm font-medium text-slate-700 hover:bg-slate-50">Zostań</button>
                <button type="button" id="leaveBtn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700">Opuść</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Mock Data ---
            const mockPatients = ['Jan Kowalski', 'Anna Nowak', 'Piotr Zieliński', 'Krystyna Wiśniewska', 'Andrzej Szymański', 'Barbara Wójcik', 'Tomasz Lewandowski', 'Zofia Dąbrowska', 'Marek Kamiński', 'Ewa Jankowska'];
            const warehouseItems = [
                { name: 'Polocard 75mg', owner: 'Dom Opieki' }, { name: 'Pieluchomajtki Seni L', owner: 'Dom Opieki' },
                { name: 'Gaza jałowa 1m x 1m', owner: 'Dom Opieki' }, { name: 'Plaster z opatrunkiem', owner: 'Dom Opieki' },
                { name: 'Paracetamol 500mg', owner: 'Dom Opieki' }, { name: 'Polocard 75mg', owner: 'Jan Kowalski' },
                { name: 'Pieluchy L', owner: 'Jan Kowalski' }, { name: 'Okulary do czytania', owner: 'Jan Kowalski' },
                { name: 'Laska ortopedyczna', owner: 'Jan Kowalski' }, { name: 'Insulina', owner: 'Anna Nowak' },
                { name: 'Aparacik słuchowy', owner: 'Anna Nowak' }
            ];

            // --- Form & Input Elements ---
            const form = document.getElementById('addTaskForm');
            const formInputs = form.querySelectorAll('.form-input');
            const patientSearchInput = document.getElementById('patientSearch');
            const patientSuggestions = document.getElementById('patientSuggestions');
            const selectedPatientInput = document.getElementById('selectedPatient');
            const warehouseInput = document.getElementById('warehouseItem');
            const warehouseSuggestions = document.getElementById('warehouseSuggestions');

            // --- Unsaved Changes Warning Logic ---
            const navLinks = document.querySelectorAll('.nav-link');
            const confirmationModal = document.getElementById('confirmationModal');
            const modalContent = confirmationModal.querySelector('.modal-content');
            const stayBtn = document.getElementById('stayBtn');
            const leaveBtn = document.getElementById('leaveBtn');
            let isFormDirty = false;
            let targetUrl = null;

            formInputs.forEach(input => {
                input.addEventListener('input', () => { isFormDirty = true; });
            });

            function openConfirmationModal(url) {
                targetUrl = url;
                confirmationModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                setTimeout(() => {
                    if (modalContent) modalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            }

            function closeConfirmationModal() {
                if (modalContent) modalContent.classList.remove('scale-100', 'opacity-100');
                setTimeout(() => {
                    confirmationModal.classList.add('hidden');
                    document.body.style.overflow = 'auto';
                    targetUrl = null;
                }, 200);
            }

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    if (isFormDirty) {
                        if (link.host !== window.location.host || link.protocol === 'mailto:') return;
                        e.preventDefault();
                        openConfirmationModal(link.href);
                    }
                });
            });

            stayBtn.addEventListener('click', closeConfirmationModal);
            leaveBtn.addEventListener('click', () => {
                if (targetUrl) {
                    isFormDirty = false; // Allow navigation
                    window.location.href = targetUrl;
                } else {
                    closeConfirmationModal();
                }
            });
            confirmationModal.addEventListener('click', e => { if (e.target === confirmationModal) closeConfirmationModal(); });
            form.addEventListener('submit', () => { isFormDirty = false; });
            window.addEventListener('beforeunload', (e) => {
              if (isFormDirty) {
                e.preventDefault(); e.returnValue = '';
              }
            });

            // --- Patient Search Logic ---
            patientSearchInput.addEventListener('input', () => {
                const query = patientSearchInput.value.toLowerCase().trim();
                patientSuggestions.innerHTML = '';
                selectedPatientInput.value = ''; // Clear hidden input if user types again

                if (query.length < 3) {
                    patientSuggestions.classList.add('hidden');
                    return;
                }

                const filteredPatients = mockPatients.filter(name => name.toLowerCase().includes(query));

                if (filteredPatients.length > 0) {
                    const list = document.createElement('ul');
                    filteredPatients.forEach(name => {
                        const listItem = document.createElement('li');
                        listItem.className = 'px-4 py-2 hover:bg-slate-100 cursor-pointer';
                        listItem.textContent = name;
                        listItem.addEventListener('click', () => {
                            patientSearchInput.value = name;
                            selectedPatientInput.value = name; // Set hidden input value
                            patientSuggestions.classList.add('hidden');
                            patientSuggestions.innerHTML = '';
                            isFormDirty = true; // Selecting a patient counts as a change
                        });
                        list.appendChild(listItem);
                    });
                    patientSuggestions.appendChild(list);
                    patientSuggestions.classList.remove('hidden');
                } else {
                     patientSuggestions.innerHTML = '<div class="px-4 py-2 text-slate-500">Brak pasujących pacjentów.</div>';
                     patientSuggestions.classList.remove('hidden');
                }
            });

            // --- Warehouse Item Search Logic ---
            warehouseInput.addEventListener('input', () => {
                const query = warehouseInput.value.toLowerCase().trim();
                warehouseSuggestions.innerHTML = '';
                const selectedPatient = selectedPatientInput.value; // Get the currently selected patient

                if (query.length < 3) {
                    warehouseSuggestions.classList.add('hidden');
                    return;
                }
                
                // Filter items: prioritize selected patient's items, then care home items
                 const patientItems = warehouseItems.filter(item =>
                    item.owner === selectedPatient && item.name.toLowerCase().includes(query)
                );
                const careHomeItems = warehouseItems.filter(item =>
                    item.owner === 'Dom Opieki' && item.name.toLowerCase().includes(query)
                );
                
                 const combinedResults = [
                    ...patientItems,
                    ...careHomeItems.filter(chItem => !patientItems.some(pItem => pItem.name === chItem.name))
                ];

                if (combinedResults.length > 0) {
                    const list = document.createElement('ul');
                    combinedResults.forEach(item => {
                        const listItem = document.createElement('li');
                        listItem.className = 'px-4 py-2 hover:bg-slate-100 cursor-pointer';
                        listItem.innerHTML = `${item.name} <span class="text-xs ${item.owner === selectedPatient ? 'text-green-600 font-semibold' : 'text-slate-500'}">(${item.owner})</span>`;
                        listItem.addEventListener('click', () => {
                            warehouseInput.value = item.name;
                            warehouseSuggestions.classList.add('hidden');
                            warehouseSuggestions.innerHTML = '';
                             isFormDirty = true;
                        });
                        list.appendChild(listItem);
                    });
                    warehouseSuggestions.appendChild(list);
                    warehouseSuggestions.classList.remove('hidden');
                } else {
                    warehouseSuggestions.innerHTML = '<div class="px-4 py-2 text-slate-500">Brak pasujących przedmiotów.</div>';
                    warehouseSuggestions.classList.remove('hidden');
                }
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!patientSearchInput.contains(e.target) && !patientSuggestions.contains(e.target)) {
                    patientSuggestions.classList.add('hidden');
                }
                 if (!warehouseInput.contains(e.target) && !warehouseSuggestions.contains(e.target)) {
                    warehouseSuggestions.classList.add('hidden');
                }
            });

        });
    </script>
</body>
</html>
